{% extends 'main.html' %}

{% block content %}
<h3>{{user.username}}</h3>
{% if user.profile.online_status %}
<small id="{{user.username}}_small">Online</small>
{% else %}
<small id="{{user.username}}_small">Offline</small>
{% endif %}
<hr>
<a href="{% url 'chats' %}">Go Back</a>
<table style="border: 1px solid black; max-height: 400px; min-height: 100px; min-width: 400px; " class="table">
    <tbody id='chat-body'>
        {% for message in messages %}
        {% if message.sender == request.user.username %}
        <tr>
            <td style="width: 400px; align-items: end; height: 10px; ">
                <p style="float: right;">
                    {{message.message}}
                    {% if message.is_seen %}
                    <small  class="{{user.username}}_seen">seen</small>
                    {% else %}
                    <small  class="{{user.username}}_seen"></small>
                    {% endif %}
                </p>
            </td>
            <!-- <td>
                <p><small class="p-1 shadow-sm">{{message.timestamp|time:'H:i'}}</small>
                </p>
            </td> -->
        </tr>
        {% else %}
        <tr>
            <td style="height: 10px; width: 400px; ">
                <p >
                    {{message.message}}
                </p>
            </td>
            <!-- <td>
                <p><small class="p-1 shadow-sm">{{message.timestamp|time:'H:i'}}</small>
                </p>
            </td> -->
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>
<div>
    <input id="input-text" type="text">
</div>
<div>
    <button id="submit-btn">send</button>
</div>

{{user.id|json_script:"json-username"}}
{{user.username|json_script:"json-username-receiver"}}
{{request.user.username|json_script:"json-message-username"}}

<script>
    const id = JSON.parse(document.getElementById('json-username').textContent);
    const message_username = JSON.parse(document.getElementById('json-message-username').textContent);
    const receiver = JSON.parse(document.getElementById('json-username-receiver').textContent);
    

    const socket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + id
        + '/'
    );

    socket.onopen = function(e){
        console.log("connection establishd");

        socket.send(JSON.stringify({
        'initial_message': true,
        'username': message_username,
        'receiver':receiver
    }))
    }

    socket.onclose = function(e){
        console.log("connection close");
    }

    socket.onerror = function(e){
        console.log(e);
    }

    socket.onmessage = function(e){
        // console.log(e);
        const data = JSON.parse(e.data);
        if (data.initial == true){
            // console.log(message_username)
            // console.log(receiver)
            if(data.username != message_username){
                // var user_to_change = document.getElementById(`${data.username}_status`)
                var is_see_list = document.querySelectorAll(`.${receiver}_seen`);
                is_see_list.forEach(function (element) {
                    element.textContent = 'seen';
                });
                
                

            }
        }else{
            if(data.username == message_username){
                var small_status_to_change = document.getElementById(`${receiver}_small`).textContent
                // var small_status_to_change = small_status_element ? small_status_element.textContent : null;
                var smallTag = '';
                if (small_status_to_change === 'Online') {
                    smallTag = 'seen';
                }
                document.querySelector('#chat-body').innerHTML += `<tr>
                                                                        <td style="width: 400px; align-items: end; height: 10px; ">
                                                                        <p style="float: right;">${data.message}  <small class="${receiver}_seen">${smallTag}</small></p>
                                                                        </td>
                                                                    </tr>`
            }else{
                document.querySelector('#chat-body').innerHTML += `<tr>
                                                                        <td style="height: 10px; ">
                                                                        <p style="float: left; width: 400px;" >${data.message}</p>
                                                                        </td>
                                                                    </tr>`
            }
        }
    }

    document.querySelector('#submit-btn').onclick = function(e){
    const message_input = document.querySelector('#input-text');
    const message = message_input.value;
    const receiver = JSON.parse(document.getElementById('json-username-receiver').textContent);

    socket.send(JSON.stringify({
        'message':message,
        'username':message_username,
        'receiver':receiver
    }));

    message_input.value = '';
}


// ONLINE STATUS

const loggedin_user = JSON.parse(document.getElementById('json-message-username').textContent);
const online_status = new WebSocket(
    'ws://'
    + window.location.host
    + '/ws/'
    + 'online/'
)

online_status.onopen = function(e){
    console.log("CONNECTED TO ONLINE CONSUMER");
    online_status.send(JSON.stringify({
        'username':loggedin_user,
        'type':'open'
    }))
}

window.addEventListener("beforeunload", function(e){
    online_status.send(JSON.stringify({
        'username':loggedin_user,
        'type':'offline'
    }))
})

online_status.onclose = function(e){
    console.log("DISCONNECTED FROM ONLINE CONSUMER")
}

online_status.onmessage = function(e){
    var data = JSON.parse(e.data)
    if(data.username != loggedin_user){
        // var user_to_change = document.getElementById(`${data.username}_status`)
        var small_status_to_change = document.getElementById(`${data.username}_small`)
        if(data.online_status == true){
            // user_to_change.style.color = 'green'
            small_status_to_change.textContent = 'Online'
        }else{
            // user_to_change.style.color = 'grey'
            small_status_to_change.textContent = 'Offline'
        }
    }
}




</script>
{% endblock content %}